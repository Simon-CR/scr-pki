# Development override for docker-compose.yml
# Usage: docker compose -f docker-compose.yml -f docker-compose.dev.yml up --build
#
# This file overrides the production compose to:
# - Build images locally instead of pulling from Docker Hub
# - Enable hot reload for frontend and backend
# - Use Vault in dev mode
# - Expose PostgreSQL port for debugging

services:
  # Nginx - Build locally
  nginx:
    image: ""  # Clear the image to force build
    build:
      context: ./nginx
      dockerfile: Dockerfile

  # Frontend - Development mode with hot reload
  frontend:
    image: ""  # Clear the image to force build
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev
    volumes:
      - ./frontend/src:/app/src
      - ./frontend/public:/app/public
      - ./frontend/package.json:/app/package.json
      - ./frontend/vite.config.ts:/app/vite.config.ts
      - ./frontend/tsconfig.json:/app/tsconfig.json
      - ./frontend/tailwind.config.js:/app/tailwind.config.js
    environment:
      - NODE_ENV=development
      - VITE_API_URL=/api/v1
      - VITE_PROXY_TARGET=http://backend:8000
      - VITE_DEV_SERVER_PORT=3000
      - VITE_HMR_PORT=${WEB_PORT:-9443}
    command: npm run dev -- --host 0.0.0.0 --port 3000

  # Backend - Development mode with hot reload
  backend:
    image: ""  # Clear the image to force build
    build:
      context: ./backend
      dockerfile: Dockerfile.dev
    volumes:
      - ./backend/app:/app/app
      - ./backend/requirements.txt:/app/requirements.txt
      - ./VERSION:/app/VERSION:ro
    environment:
      - ENVIRONMENT=development
      - DEBUG=true
      - LOG_LEVEL=DEBUG
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload

  # PostgreSQL - Use standard image and expose port
  postgres:
    image: postgres:15-alpine
    ports:
      - "5432:5432"
    volumes:
      - ./data/postgres:/var/lib/postgresql/data
      - ./scripts/init-db.sql:/docker-entrypoint-initdb.d/init.sql:ro

  # Vault in development mode
  vault:
    environment:
      - VAULT_DEV_ROOT_TOKEN_ID=dev-root-token
      - VAULT_DEV_LISTEN_ADDRESS=0.0.0.0:8200
    command: vault server -dev -dev-listen-address=0.0.0.0:8200

  # Monitor - Build locally
  monitor:
    image: ""  # Clear the image to force build
    build:
      context: ./monitor
      dockerfile: Dockerfile